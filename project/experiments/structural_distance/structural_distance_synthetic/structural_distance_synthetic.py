import os, sys, pickle, json, re, random

from networkx import cost_of_flow
import test
import numpy as np
from multiprocessing import Pool, current_process
import networkx as nx
import torch, glob
from pulp import LpProblem, LpMinimize, LpVariable, lpSum
import matplotlib.pyplot as plt

# DIRECTORY = "/home/ubuntu/project"
DIRECTORY = "/Users/ilanashapiro/Documents/constraints_project/project"
# DIRECTORY = "/home/ilshapiro/project"

sys.path.append(f"{DIRECTORY}/centroid")
import z3_matrix_projection_incremental as z3_repair
import simanneal_centroid_helpers, simanneal_centroid_run
# import build_graph

import matplotlib.pyplot as plt

def plot_results():
		# Data for Bach
		noise_vals = [
				0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 
				1.5, 1.6, 1.7, 1.8, 1.9, 2.0, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 
				2.9, 3.0
		]

		struct_dist_errors_bach = [
				0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
				0.0027285180318334474, 0.0, 0.0, 0.0, 0.0, 0.0020470850492694836, 
				0.019648280379218157, 0.018763393054249768, 0.007142948579625529, 
				0.03827515589545143, 0.03504013504000757, 0.035211105960017176, 
				0.03077663080488022, 0.05719095841793652, 0.06723180951795885, 0.05477906130322126
		]

		# Data for Beethoven 461
		struct_dist_errors_beethoven461 = [
				0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
				0.0, 0.0, 0.0, 0.0, 0.005420094115515972, 0.002574006832043138,
				0.08712907082472314, 0.03810933840700321, 0.05982524420798693, 
				0.03050829653362744, 0.042035766194254656, 0.0911067408536142, 
				0.058991932443665594, 0.07645185481720104, 0.06981280005025085, 
				0.10327054729968504
		]

		struct_dist_errors_beethoven811 = [
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.005830953497718259, 0.0, 
			0.005221967807223131, 0.032713297746507976, 0.0, 
			0.041207785174096026, 0.039402903858293, 0.029233894660655048, 
			0.05277605521132031, 0.05071569884957737, 0.0722037611598865, 
			0.05448800490835086, 0.07444325398040072, 0.05602483670867122
		]

		struct_dist_errors_beethoven317 = [
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
			0.002412548741482971, 0.0, 0.0, 0.008064647786012352, 0.0, 0.03879604480721117, 
			0.0, 0.019935555287575325, 0.035211105960017176, 0.027486178745967482, 
			0.045984838937959106, 0.051463522858521446, 0.04666522932046849, 
			0.061311046776200306, 0.059103202767490544, 0.043203816271162314
		]

		struct_dist_errors_beethoven360 = [
				0.0, 0.0, 0.0, 0.0, 0.0, 0.005167993252386094, 0.004434611651310924,
				0.0, 0.0, 0.0, 0.0, 0.002594038091940772, 0.0, 0.0, 0.002081167703827602,
				0.001951221367587408, 0.0018365488382998093, 0.001734606680942415, 
				0.0016433864825395694, 0.023718790511668343, 0.0014892041025247524,
				0.02736300333951558, 0.0, 0.031670336268511415, 0.0012492197250393744,
				0.03299630101733631, 0.0389531171107671, 0.04791870235394588, 
				0.050750154692030314, 0.030678931760310196
		]

		plt.figure(figsize=(8, 3))
		plt.plot(noise_vals, struct_dist_errors_bach, marker='o', linestyle='--', color='b', label='Bach BWV 876, |E| = 122')
		plt.plot(noise_vals, struct_dist_errors_beethoven461, marker='o', linestyle='--', color='r', label='Beethoven Biamonti No. 461, |E| = 97')
		plt.plot(noise_vals, struct_dist_errors_beethoven811, marker='o', linestyle='--', color='g', label='Beethoven Biamonti No. 811, |E| = 101')
		plt.plot(noise_vals, struct_dist_errors_beethoven317, marker='o', linestyle='--', color='m', label='Beethoven Biamonti No. 317, |E| = 138')
		plt.plot(noise_vals, struct_dist_errors_beethoven360, marker='o', linestyle='--', color='c', label='Beethoven Biamonti No. 360, |E| = 160')
		plt.legend(fontsize=12)

		plt.xlabel('$p$', fontsize=20, labelpad=1)
		plt.ylabel('Relative Error', fontsize=20, labelpad=1)
		plt.tick_params(axis='both', which='major', labelsize=15)
		
		plt.show()

plot_results()


def load_STG(stg_path):
	with open(stg_path, 'rb') as f:
		graph = pickle.load(f)
	return graph

def parse_node_name(node_name):
		# Prototype nodes of the form "PrS{n}" or "PrP{n}"
		proto_match = re.match(r"Pr([SP])(\d+)", node_name)
		if proto_match:
			return {
				"type": "prototype",
				"kind": proto_match.group(1),
				"n": int(proto_match.group(2)),
			}
		
		# Instance nodes of the form "S{n1}L{n2}N{n3}" or "P{n1}O{n2}N{n3}"
		instance_match = re.match(r"([SP])(\d+)L?O?(\d+)N(\d+)", node_name)
		if instance_match:
			return {
				"type": "instance",
				"kind": instance_match.group(1),
				"n1": int(instance_match.group(2)),
				"n2": int(instance_match.group(3)),
				"n3": int(instance_match.group(4)),
			}
		
		# If the node name does not match any known format
		return {
			"type": "unknown",
			"name": node_name
		}

def is_approx_valid_move(source_node_name, sink_node_name):
		source_info = parse_node_name(source_node_name)
		sink_info = parse_node_name(sink_node_name)

		# The edge is from an instance to a prototype 
		if source_info['type'] == 'instance' and sink_info['type'] == 'prototype':
			return False
		
		# The edge is between two prototypes
		if source_info['type'] == 'prototype' and sink_info['type'] == 'prototype':
			return False
		
		# The edge is from the wrong prototype to an instance (i.e. PrP{n} to S{n1}L{n2}N{n3} or PrS{n} to P{n1}O{n2}N{n3})
		if source_info['type'] == 'prototype' and sink_info['type'] == 'instance' and source_info['kind'] != sink_info['kind']:
			return False
		
		# The edge is from a lower level to a higher level instance node (so either from P{n1}O{n2}N{n3} to S{n1}L{n2}N{n3}, or from S{n1}L{n2}N{n3} to S{n1'}L{n2'}N{n3'} where n2 > n2')
		if source_info['type'] == 'instance' and sink_info['type'] == 'instance':
			if source_info['kind'] == 'P' and sink_info['kind'] == 'S':
				return False
			if source_info['kind'] == 'S' and sink_info['kind'] == 'S' and source_info['n2'] > sink_info['n2']:
				return False

		return True

def is_formally_valid_graph(new_STG, verbose=False):
	adj_matrix, idx_node_mapping, node_metadata_dict = simanneal_centroid_helpers.pad_adj_matrices([new_STG])
	z3_repair.initialize_globals(adj_matrix, idx_node_mapping, node_metadata_dict)
	return z3_repair.test_sat(verbose=verbose)

def add_noise_to_graph(graph, n_edits):
	# Create a copy of the original graph to avoid modifying it directly
	noisy_graph = graph.copy()
	nodes = list(noisy_graph.nodes)

	# Track changes to ensure noise doesn't decrease
	removed_edges = set()
	added_edges = set()
	
	noise_level = 0
	batch_changes = []
	batch_size = 40 # how much noise to add before checking validity, so we possibly need to rollback this many changes if it isn't valid

	while noise_level < n_edits:
		operation = random.choice(["add", "remove"])
		
		if operation == "add":
			u, v = random.sample(nodes, 2)
			# don't want to re-add an edge that was already removed -- this undoes the noise addition
			if (u,v) not in removed_edges\
					and u != v \
					and not noisy_graph.has_edge(u, v) \
					and is_approx_valid_move(u,v):
				noisy_graph.add_edge(u, v)
				added_edges.add((u, v))
				batch_changes.append(("add", u, v))
			else:
				print(f"invalid attempt to add edge. currently at noise level {noise_level}")
				continue
		
		elif operation == "remove":
			if noisy_graph.number_of_edges() > 0:
				edge = random.choice(list(noisy_graph.edges))
				# don't want to re-remove an edge that was already added -- this undoes the noise addition
				if edge not in added_edges:
					noisy_graph.remove_edge(*edge)
					removed_edges.add(edge)
					batch_changes.append(("remove", *edge))
				else:
					print(f"invalid attempt to remove edge. currently at noise level {noise_level}")
					continue
			else:
				print(f"invalid attempt to remove edge. currently at noise level {noise_level}")
				continue
		
		noise_level += 1

		if noise_level % batch_size == 0 or noise_level == n_edits:
			if not is_formally_valid_graph(noisy_graph, verbose=False):
				rollback_count = min(len(batch_changes), noise_level)  # Handle last few edits case
				print(f"Invalid batch detected. Rolling back last {rollback_count} operations. Noise level was {noise_level}.")
				
				# Rollback only the necessary changes
				for _ in range(rollback_count):
					op, u, v = batch_changes.pop()
					if op == "add":
						noisy_graph.remove_edge(u, v)
						added_edges.remove((u, v))
					elif op == "remove":
						noisy_graph.add_edge(u, v)
						removed_edges.remove((u, v))
				
				# Rollback noise level
				noise_level -= rollback_count
			else:
					batch_changes.clear()  # Clear batch if valid

	print("done")
	return noisy_graph

def load_noisy_STGs(noisy_STGs_dir):
	pickle_files = [f for f in os.listdir(noisy_STGs_dir) if f.endswith(".pickle")]

	def extract_number(filename):
			match = re.search(r"_(\d+)\.pickle$", filename)
			return int(match.group(1)) if match else float('inf')  # Default to inf if no number found

	pickle_files.sort(key=extract_number)
	noisy_graphs = []
	for filename in pickle_files:
			file_path = os.path.join(noisy_STGs_dir, filename)
			with open(file_path, 'rb') as f:
					noisy_graphs.append(pickle.load(f))
	
	return noisy_graphs

def structural_distance(G1, G2, noisy_corpus_dirname="", gpu_id=0):
	device = torch.device(f'cuda:{gpu_id}' if torch.cuda.is_available() else 'cpu')
	# print(f"Process {current_process().name} running on GPU {device} for STGs derived from {noisy_corpus_dirname}")

	STG_augmented_list = [G1, G2]
	listA_G, idx_node_mapping, node_metadata_dict = simanneal_centroid_helpers.pad_adj_matrices(STG_augmented_list)
	# A_G1, A_G2 = cp.asarray(listA_G[0]), cp.asarray(listA_G[1]) 
	# A_G1, A_G2 = np.asarray(listA_G[0]), np.asarray(listA_G[1]) 
	A_G1, A_G2 = torch.from_numpy(listA_G[0]).to(device), torch.from_numpy(listA_G[1]).to(device)
	_, structural_distance = simanneal_centroid_run.align_graph_pair(A_G1, A_G2, idx_node_mapping, node_metadata_dict, device=device)
	return structural_distance.item()

def generate_noisy_STGs(base_graph, percent_noise_max, percent_noise_increment, noisy_STGs_save_dir):
	noisy_graphs = []
	noise_percent_level = percent_noise_increment
	eps = 1e-6
	while noise_percent_level <= percent_noise_max + eps: # bc of rounding errors
		noise = int(np.ceil(base_graph.size()*noise_percent_level))
		noisy_graphs.append(add_noise_to_graph(base_graph, noise))
		print("Finished generating STGs with noise percent", noise_percent_level, "and noise", noise)
		noise_percent_level += percent_noise_increment

	os.makedirs(noisy_STGs_save_dir, exist_ok=True)
	for i, noisy_graph in enumerate(noisy_graphs):
		file_path = os.path.join(noisy_STGs_save_dir, f"{noisy_STGs_dirname}_{i+1}.pickle")
		with open(file_path, 'wb') as f:
				pickle.dump(noisy_graph, f)

	print(f"Saved graphs with noise up to {percent_noise_max*100}% percent in increments of {percent_noise_increment*100}% to {noisy_STGs_save_dir}")

if __name__ == "__main__":
	plot_results()
	sys.exit(0)
	
	base_graph_paths = [
		DIRECTORY + '/datasets/bach/kunstderfuge/bwv876frag/bwv876frag_augmented_graph_flat.pickle',
		DIRECTORY + '/datasets/beethoven/kunstderfuge/biamonti_461_(c)orlandi/biamonti_461_(c)orlandi_augmented_graph_flat.pickle',
		DIRECTORY +'/datasets/beethoven/kunstderfuge/biamonti_811_(c)orlandi/biamonti_811_(c)orlandi_augmented_graph_flat.pickle',
		DIRECTORY + '/datasets/beethoven/kunstderfuge/biamonti_317_(c)orlandi/biamonti_317_(c)orlandi_augmented_graph_flat.pickle',
		DIRECTORY + '/datasets/beethoven/kunstderfuge/biamonti_360_(c)orlandi/biamonti_360_(c)orlandi_augmented_graph_flat.pickle'
	]

	for base_graph_path in base_graph_paths:
		print("BASE GRAPH", base_graph_path)
		base_graph = load_STG(base_graph_path)
		print("|E| =", base_graph.size())
		continue
		percent_noise_max = 3 # this is 300%
		percent_noise_increment = 0.1 # 10% increments in noise 
		gpu_id = 7
		
		noisy_STGs_dirname = "noisy_STGs_" + os.path.basename(os.path.dirname(base_graph_path)) + f"_max_percent{percent_noise_max*100}_increment{percent_noise_increment*100}"
		noisy_STGs_save_dir = DIRECTORY + f'/experiments/structural_distance/structural_distance_synthetic/{noisy_STGs_dirname}'
		if not os.path.exists(noisy_STGs_save_dir):
			generate_noisy_STGs(base_graph, percent_noise_max, percent_noise_increment, noisy_STGs_save_dir)
		
		noisy_STGs = load_noisy_STGs(noisy_STGs_save_dir)
			
		for i, G in enumerate(noisy_STGs):
			noise_percent = percent_noise_increment * (i+1)
			noise = int(np.ceil(base_graph.size()*noise_percent))
			ground_truth = np.sqrt(noise)
			struct_dist = structural_distance(base_graph, G, noisy_STGs_dirname, gpu_id=gpu_id)
			print(f"AT NOISE PERCENT {noise_percent}, STRUCT DIST ERROR:",  np.abs(struct_dist-ground_truth)/ground_truth)
			print("NOSIE", noise, "STRUCT DIST", struct_dist, "GROUND TRUTH", ground_truth)
			print()

# BASE GRAPH /home/ubuntu/project/datasets/bach/kunstderfuge/bwv876frag/bwv876frag_augmented_graph_flat.pickle
# |E| = 122
# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_461_(c)orlandi/biamonti_461_(c)orlandi_augmented_graph_flat.pickle
# |E| = 97
# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_811_(c)orlandi/biamonti_811_(c)orlandi_augmented_graph_flat.pickle
# |E| = 101
# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_317_(c)orlandi/biamonti_317_(c)orlandi_augmented_graph_flat.pickle
# |E| = 138
# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_360_(c)orlandi/biamonti_360_(c)orlandi_augmented_graph_flat.pickle
# |E| = 160

# BASE GRAPH /home/ubuntu/project/datasets/bach/kunstderfuge/bwv876frag/bwv876frag_augmented_graph_flat.pickle
# AT NOISE PERCENT 0.1, STRUCT DIST ERROR: 0.0
# NOSIE 13 STRUCT DIST 3.605551275463989 GROUND TRUTH 3.605551275463989

# AT NOISE PERCENT 0.2, STRUCT DIST ERROR: 0.0
# NOSIE 25 STRUCT DIST 5.0 GROUND TRUTH 5.0

# AT NOISE PERCENT 0.3, STRUCT DIST ERROR: 0.0
# NOSIE 37 STRUCT DIST 6.082762530298219 GROUND TRUTH 6.082762530298219

# AT NOISE PERCENT 0.4, STRUCT DIST ERROR: 0.0
# NOSIE 49 STRUCT DIST 7.0 GROUND TRUTH 7.0

# AT NOISE PERCENT 0.5, STRUCT DIST ERROR: 0.0
# NOSIE 61 STRUCT DIST 7.810249675906654 GROUND TRUTH 7.810249675906654

# AT NOISE PERCENT 0.6, STRUCT DIST ERROR: 0.0
# NOSIE 74 STRUCT DIST 8.602325267042627 GROUND TRUTH 8.602325267042627

# AT NOISE PERCENT 0.7, STRUCT DIST ERROR: 0.0
# NOSIE 86 STRUCT DIST 9.273618495495704 GROUND TRUTH 9.273618495495704

# AT NOISE PERCENT 0.8, STRUCT DIST ERROR: 0.0
# NOSIE 98 STRUCT DIST 9.899494936611665 GROUND TRUTH 9.899494936611665

# AT NOISE PERCENT 0.9, STRUCT DIST ERROR: 0.0
# NOSIE 110 STRUCT DIST 10.488088481701515 GROUND TRUTH 10.488088481701515

# AT NOISE PERCENT 1.0, STRUCT DIST ERROR: 0.0
# NOSIE 122 STRUCT DIST 11.045361017187261 GROUND TRUTH 11.045361017187261

# AT NOISE PERCENT 1.1, STRUCT DIST ERROR: 0.0
# NOSIE 135 STRUCT DIST 11.61895003862225 GROUND TRUTH 11.61895003862225

# AT NOISE PERCENT 1.2, STRUCT DIST ERROR: 0.0
# NOSIE 147 STRUCT DIST 12.12435565298214 GROUND TRUTH 12.12435565298214

# AT NOISE PERCENT 1.3, STRUCT DIST ERROR: 0.0
# NOSIE 159 STRUCT DIST 12.609520212918492 GROUND TRUTH 12.609520212918492

# AT NOISE PERCENT 1.4, STRUCT DIST ERROR: 0.0
# NOSIE 171 STRUCT DIST 13.076696830622021 GROUND TRUTH 13.076696830622021

# AT NOISE PERCENT 1.5, STRUCT DIST ERROR: 0.0027285180318334474
# NOSIE 183 STRUCT DIST 13.564659966250536 GROUND TRUTH 13.527749258468683

# AT NOISE PERCENT 1.6, STRUCT DIST ERROR: 0.0
# NOSIE 196 STRUCT DIST 14.0 GROUND TRUTH 14.0

# AT NOISE PERCENT 1.7, STRUCT DIST ERROR: 0.0
# NOSIE 208 STRUCT DIST 14.422205101855956 GROUND TRUTH 14.422205101855956

# AT NOISE PERCENT 1.8, STRUCT DIST ERROR: 0.0
# NOSIE 220 STRUCT DIST 14.832396974191326 GROUND TRUTH 14.832396974191326

# AT NOISE PERCENT 1.9, STRUCT DIST ERROR: 0.0
# NOSIE 232 STRUCT DIST 15.231546211727817 GROUND TRUTH 15.231546211727817

# AT NOISE PERCENT 2.0, STRUCT DIST ERROR: 0.0020470850492694836
# NOSIE 244 STRUCT DIST 15.652475842498529 GROUND TRUTH 15.620499351813308

# AT NOISE PERCENT 2.1, STRUCT DIST ERROR: 0.019648280379218157
# NOSIE 257 STRUCT DIST 15.716233645501712 GROUND TRUTH 16.0312195418814

# AT NOISE PERCENT 2.2, STRUCT DIST ERROR: 0.018763393054249768
# NOSIE 269 STRUCT DIST 16.09347693943108 GROUND TRUTH 16.401219466856727

# AT NOISE PERCENT 2.3, STRUCT DIST ERROR: 0.007142948579625529
# NOSIE 281 STRUCT DIST 16.64331697709324 GROUND TRUTH 16.76305461424021

# AT NOISE PERCENT 2.4, STRUCT DIST ERROR: 0.03827515589545143
# NOSIE 293 STRUCT DIST 16.46207763315433 GROUND TRUTH 17.11724276862369

# AT NOISE PERCENT 2.5, STRUCT DIST ERROR: 0.03504013504000757
# NOSIE 305 STRUCT DIST 16.852299546352718 GROUND TRUTH 17.46424919657298

# AT NOISE PERCENT 2.6, STRUCT DIST ERROR: 0.035211105960017176
# NOSIE 318 STRUCT DIST 17.204650534085253 GROUND TRUTH 17.832554500127006

# AT NOISE PERCENT 2.7, STRUCT DIST ERROR: 0.03077663080488022
# NOSIE 330 STRUCT DIST 17.60681686165901 GROUND TRUTH 18.16590212458495

# AT NOISE PERCENT 2.8, STRUCT DIST ERROR: 0.05719095841793652
# NOSIE 342 STRUCT DIST 17.435595774162696 GROUND TRUTH 18.49324200890693

# AT NOISE PERCENT 2.9, STRUCT DIST ERROR: 0.06723180951795885
# NOSIE 354 STRUCT DIST 17.549928774784245 GROUND TRUTH 18.81488772222678

# AT NOISE PERCENT 3.0, STRUCT DIST ERROR: 0.05477906130322126
# NOSIE 366 STRUCT DIST 18.083141320025124 GROUND TRUTH 19.131126469708992

# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_461_(c)orlandi/biamonti_461_(c)orlandi_augmented_graph_flat.pickle
# AT NOISE PERCENT 0.1, STRUCT DIST ERROR: 0.0
# NOSIE 10 STRUCT DIST 3.1622776601683795 GROUND TRUTH 3.1622776601683795

# AT NOISE PERCENT 0.2, STRUCT DIST ERROR: 0.0
# NOSIE 20 STRUCT DIST 4.47213595499958 GROUND TRUTH 4.47213595499958

# AT NOISE PERCENT 0.3, STRUCT DIST ERROR: 0.0
# NOSIE 30 STRUCT DIST 5.477225575051661 GROUND TRUTH 5.477225575051661

# AT NOISE PERCENT 0.4, STRUCT DIST ERROR: 0.0
# NOSIE 39 STRUCT DIST 6.244997998398398 GROUND TRUTH 6.244997998398398

# AT NOISE PERCENT 0.5, STRUCT DIST ERROR: 0.0
# NOSIE 49 STRUCT DIST 7.0 GROUND TRUTH 7.0

# AT NOISE PERCENT 0.6, STRUCT DIST ERROR: 0.0
# NOSIE 59 STRUCT DIST 7.681145747868608 GROUND TRUTH 7.681145747868608

# AT NOISE PERCENT 0.7, STRUCT DIST ERROR: 0.0
# NOSIE 68 STRUCT DIST 8.246211251235321 GROUND TRUTH 8.246211251235321

# AT NOISE PERCENT 0.8, STRUCT DIST ERROR: 0.0
# NOSIE 78 STRUCT DIST 8.831760866327848 GROUND TRUTH 8.831760866327848

# AT NOISE PERCENT 0.9, STRUCT DIST ERROR: 0.0
# NOSIE 88 STRUCT DIST 9.38083151964686 GROUND TRUTH 9.38083151964686

# AT NOISE PERCENT 1.0, STRUCT DIST ERROR: 0.0
# NOSIE 97 STRUCT DIST 9.848857801796104 GROUND TRUTH 9.848857801796104

# AT NOISE PERCENT 1.1, STRUCT DIST ERROR: 0.0
# NOSIE 107 STRUCT DIST 10.344080432788601 GROUND TRUTH 10.344080432788601

# AT NOISE PERCENT 1.2, STRUCT DIST ERROR: 0.0
# NOSIE 117 STRUCT DIST 10.816653826391969 GROUND TRUTH 10.816653826391969

# AT NOISE PERCENT 1.3, STRUCT DIST ERROR: 0.0
# NOSIE 127 STRUCT DIST 11.269427669584644 GROUND TRUTH 11.269427669584644

# AT NOISE PERCENT 1.4, STRUCT DIST ERROR: 0.0
# NOSIE 136 STRUCT DIST 11.661903789690601 GROUND TRUTH 11.661903789690601

# AT NOISE PERCENT 1.5, STRUCT DIST ERROR: 0.0
# NOSIE 146 STRUCT DIST 12.083045973594572 GROUND TRUTH 12.083045973594572

# AT NOISE PERCENT 1.6, STRUCT DIST ERROR: 0.0
# NOSIE 156 STRUCT DIST 12.489995996796797 GROUND TRUTH 12.489995996796797

# AT NOISE PERCENT 1.7, STRUCT DIST ERROR: 0.0
# NOSIE 165 STRUCT DIST 12.84523257866513 GROUND TRUTH 12.84523257866513

# AT NOISE PERCENT 1.8, STRUCT DIST ERROR: 0.0
# NOSIE 175 STRUCT DIST 13.228756555322953 GROUND TRUTH 13.228756555322953

# AT NOISE PERCENT 1.9, STRUCT DIST ERROR: 0.005420094115515972
# NOSIE 185 STRUCT DIST 13.527749258468683 GROUND TRUTH 13.601470508735444

# AT NOISE PERCENT 2.0, STRUCT DIST ERROR: 0.002574006832043138
# NOSIE 194 STRUCT DIST 13.96424004376894 GROUND TRUTH 13.92838827718412

# AT NOISE PERCENT 2.1, STRUCT DIST ERROR: 0.08712907082472314
# NOSIE 204 STRUCT DIST 13.038404810405298 GROUND TRUTH 14.2828568570857

# AT NOISE PERCENT 2.2, STRUCT DIST ERROR: 0.03810933840700321
# NOSIE 214 STRUCT DIST 14.071247279470288 GROUND TRUTH 14.628738838327793

# AT NOISE PERCENT 2.3, STRUCT DIST ERROR: 0.05982524420798693
# NOSIE 224 STRUCT DIST 14.071247279470288 GROUND TRUTH 14.966629547095765

# AT NOISE PERCENT 2.4, STRUCT DIST ERROR: 0.03050829653362744
# NOSIE 233 STRUCT DIST 14.798648586948742 GROUND TRUTH 15.264337522473747

# AT NOISE PERCENT 2.5, STRUCT DIST ERROR: 0.042035766194254656
# NOSIE 243 STRUCT DIST 14.933184523068078 GROUND TRUTH 15.588457268119896

# AT NOISE PERCENT 2.6, STRUCT DIST ERROR: 0.0911067408536142
# NOSIE 253 STRUCT DIST 14.45683229480096 GROUND TRUTH 15.905973720586866

# AT NOISE PERCENT 2.7, STRUCT DIST ERROR: 0.058991932443665594
# NOSIE 262 STRUCT DIST 15.231546211727817 GROUND TRUTH 16.186414056238647

# AT NOISE PERCENT 2.8, STRUCT DIST ERROR: 0.07645185481720104
# NOSIE 272 STRUCT DIST 15.231546211727817 GROUND TRUTH 16.492422502470642

# AT NOISE PERCENT 2.9, STRUCT DIST ERROR: 0.06981280005025085
# NOSIE 282 STRUCT DIST 15.620499351813308 GROUND TRUTH 16.792855623746664

# AT NOISE PERCENT 3.0, STRUCT DIST ERROR: 0.10327054729968504
# NOSIE 291 STRUCT DIST 15.297058540778355 GROUND TRUTH 17.05872210923198

# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_811_(c)orlandi/biamonti_811_(c)orlandi_augmented_graph_flat.pickle
# AT NOISE PERCENT 0.1, STRUCT DIST ERROR: 0.0
# NOSIE 11 STRUCT DIST 3.3166247903554 GROUND TRUTH 3.3166247903554

# AT NOISE PERCENT 0.2, STRUCT DIST ERROR: 0.0
# NOSIE 21 STRUCT DIST 4.58257569495584 GROUND TRUTH 4.58257569495584

# AT NOISE PERCENT 0.3, STRUCT DIST ERROR: 0.0
# NOSIE 31 STRUCT DIST 5.5677643628300215 GROUND TRUTH 5.5677643628300215

# AT NOISE PERCENT 0.4, STRUCT DIST ERROR: 0.0
# NOSIE 41 STRUCT DIST 6.4031242374328485 GROUND TRUTH 6.4031242374328485

# AT NOISE PERCENT 0.5, STRUCT DIST ERROR: 0.0
# NOSIE 51 STRUCT DIST 7.14142842854285 GROUND TRUTH 7.14142842854285

# AT NOISE PERCENT 0.6, STRUCT DIST ERROR: 0.0
# NOSIE 61 STRUCT DIST 7.810249675906654 GROUND TRUTH 7.810249675906654

# AT NOISE PERCENT 0.7, STRUCT DIST ERROR: 0.0
# NOSIE 71 STRUCT DIST 8.426149773176359 GROUND TRUTH 8.426149773176359

# AT NOISE PERCENT 0.8, STRUCT DIST ERROR: 0.0
# NOSIE 81 STRUCT DIST 9.0 GROUND TRUTH 9.0

# AT NOISE PERCENT 0.9, STRUCT DIST ERROR: 0.0
# NOSIE 91 STRUCT DIST 9.539392014169456 GROUND TRUTH 9.539392014169456

# AT NOISE PERCENT 1.0, STRUCT DIST ERROR: 0.0
# NOSIE 101 STRUCT DIST 10.04987562112089 GROUND TRUTH 10.04987562112089

# AT NOISE PERCENT 1.1, STRUCT DIST ERROR: 0.0
# NOSIE 112 STRUCT DIST 10.583005244258363 GROUND TRUTH 10.583005244258363

# AT NOISE PERCENT 1.2, STRUCT DIST ERROR: 0.0
# NOSIE 122 STRUCT DIST 11.045361017187261 GROUND TRUTH 11.045361017187261

# AT NOISE PERCENT 1.3, STRUCT DIST ERROR: 0.0
# NOSIE 132 STRUCT DIST 11.489125293076057 GROUND TRUTH 11.489125293076057

# AT NOISE PERCENT 1.4, STRUCT DIST ERROR: 0.0
# NOSIE 142 STRUCT DIST 11.916375287812984 GROUND TRUTH 11.916375287812984

# AT NOISE PERCENT 1.5, STRUCT DIST ERROR: 0.0
# NOSIE 152 STRUCT DIST 12.328828005937952 GROUND TRUTH 12.328828005937952

# AT NOISE PERCENT 1.6, STRUCT DIST ERROR: 0.0
# NOSIE 162 STRUCT DIST 12.727922061357855 GROUND TRUTH 12.727922061357855

# AT NOISE PERCENT 1.7, STRUCT DIST ERROR: 0.005830953497718259
# NOSIE 172 STRUCT DIST 13.038404810405298 GROUND TRUTH 13.114877048604

# AT NOISE PERCENT 1.8, STRUCT DIST ERROR: 0.0
# NOSIE 182 STRUCT DIST 13.490737563232042 GROUND TRUTH 13.490737563232042

# AT NOISE PERCENT 1.9, STRUCT DIST ERROR: 0.005221967807223131
# NOSIE 192 STRUCT DIST 13.784048752090222 GROUND TRUTH 13.856406460551018

# AT NOISE PERCENT 2.0, STRUCT DIST ERROR: 0.032713297746507976
# NOSIE 202 STRUCT DIST 13.74772708486752 GROUND TRUTH 14.212670403551895

# AT NOISE PERCENT 2.1, STRUCT DIST ERROR: 0.0
# NOSIE 213 STRUCT DIST 14.594519519326424 GROUND TRUTH 14.594519519326424

# AT NOISE PERCENT 2.2, STRUCT DIST ERROR: 0.041207785174096026
# NOSIE 223 STRUCT DIST 14.317821063276353 GROUND TRUTH 14.933184523068078

# AT NOISE PERCENT 2.3, STRUCT DIST ERROR: 0.039402903858293
# NOSIE 233 STRUCT DIST 14.66287829861518 GROUND TRUTH 15.264337522473747

# AT NOISE PERCENT 2.4, STRUCT DIST ERROR: 0.029233894660655048
# NOSIE 243 STRUCT DIST 15.132745950421556 GROUND TRUTH 15.588457268119896

# AT NOISE PERCENT 2.5, STRUCT DIST ERROR: 0.05277605521132031
# NOSIE 253 STRUCT DIST 15.066519173319364 GROUND TRUTH 15.905973720586866

# AT NOISE PERCENT 2.6, STRUCT DIST ERROR: 0.05071569884957737
# NOSIE 263 STRUCT DIST 15.394804318340652 GROUND TRUTH 16.217274740226856

# AT NOISE PERCENT 2.7, STRUCT DIST ERROR: 0.0722037611598865
# NOSIE 273 STRUCT DIST 15.329709716755891 GROUND TRUTH 16.522711641858304

# AT NOISE PERCENT 2.8, STRUCT DIST ERROR: 0.05448800490835086
# NOSIE 283 STRUCT DIST 15.905973720586866 GROUND TRUTH 16.822603841260722

# AT NOISE PERCENT 2.9, STRUCT DIST ERROR: 0.07444325398040072
# NOSIE 293 STRUCT DIST 15.84297951775486 GROUND TRUTH 17.11724276862369

# AT NOISE PERCENT 3.0, STRUCT DIST ERROR: 0.05602483670867122
# NOSIE 303 STRUCT DIST 16.431676725154983 GROUND TRUTH 17.406895185529212

# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_317_(c)orlandi/biamonti_317_(c)orlandi_augmented_graph_flat.pickle
# AT NOISE PERCENT 0.1, STRUCT DIST ERROR: 0.0
# NOSIE 14 STRUCT DIST 3.7416573867739413 GROUND TRUTH 3.7416573867739413

# AT NOISE PERCENT 0.2, STRUCT DIST ERROR: 0.0
# NOSIE 28 STRUCT DIST 5.291502622129181 GROUND TRUTH 5.291502622129181

# AT NOISE PERCENT 0.3, STRUCT DIST ERROR: 0.0
# NOSIE 42 STRUCT DIST 6.48074069840786 GROUND TRUTH 6.48074069840786

# AT NOISE PERCENT 0.4, STRUCT DIST ERROR: 0.0
# NOSIE 56 STRUCT DIST 7.483314773547883 GROUND TRUTH 7.483314773547883

# AT NOISE PERCENT 0.5, STRUCT DIST ERROR: 0.0
# NOSIE 69 STRUCT DIST 8.306623862918075 GROUND TRUTH 8.306623862918075

# AT NOISE PERCENT 0.6, STRUCT DIST ERROR: 0.0
# NOSIE 83 STRUCT DIST 9.1104335791443 GROUND TRUTH 9.1104335791443

# AT NOISE PERCENT 0.7, STRUCT DIST ERROR: 0.0
# NOSIE 97 STRUCT DIST 9.848857801796104 GROUND TRUTH 9.848857801796104

# AT NOISE PERCENT 0.8, STRUCT DIST ERROR: 0.0
# NOSIE 111 STRUCT DIST 10.535653752852738 GROUND TRUTH 10.535653752852738

# AT NOISE PERCENT 0.9, STRUCT DIST ERROR: 0.0
# NOSIE 125 STRUCT DIST 11.180339887498949 GROUND TRUTH 11.180339887498949

# AT NOISE PERCENT 1.0, STRUCT DIST ERROR: 0.0
# NOSIE 138 STRUCT DIST 11.74734012447073 GROUND TRUTH 11.74734012447073

# AT NOISE PERCENT 1.1, STRUCT DIST ERROR: 0.0
# NOSIE 152 STRUCT DIST 12.328828005937952 GROUND TRUTH 12.328828005937952

# AT NOISE PERCENT 1.2, STRUCT DIST ERROR: 0.0
# NOSIE 166 STRUCT DIST 12.884098726725126 GROUND TRUTH 12.884098726725126

# AT NOISE PERCENT 1.3, STRUCT DIST ERROR: 0.0
# NOSIE 180 STRUCT DIST 13.416407864998739 GROUND TRUTH 13.416407864998739

# AT NOISE PERCENT 1.4, STRUCT DIST ERROR: 0.0
# NOSIE 194 STRUCT DIST 13.92838827718412 GROUND TRUTH 13.92838827718412

# AT NOISE PERCENT 1.5, STRUCT DIST ERROR: 0.002412548741482971
# NOSIE 207 STRUCT DIST 14.422205101855956 GROUND TRUTH 14.38749456993816

# AT NOISE PERCENT 1.6, STRUCT DIST ERROR: 0.0
# NOSIE 221 STRUCT DIST 14.866068747318506 GROUND TRUTH 14.866068747318506

# AT NOISE PERCENT 1.7, STRUCT DIST ERROR: 0.0
# NOSIE 235 STRUCT DIST 15.329709716755891 GROUND TRUTH 15.329709716755891

# AT NOISE PERCENT 1.8, STRUCT DIST ERROR: 0.008064647786012352
# NOSIE 249 STRUCT DIST 15.652475842498529 GROUND TRUTH 15.7797338380595

# AT NOISE PERCENT 1.9, STRUCT DIST ERROR: 0.0
# NOSIE 263 STRUCT DIST 16.217274740226856 GROUND TRUTH 16.217274740226856

# AT NOISE PERCENT 2.0, STRUCT DIST ERROR: 0.03879604480721117
# NOSIE 276 STRUCT DIST 15.968719422671311 GROUND TRUTH 16.61324772583615

# AT NOISE PERCENT 2.1, STRUCT DIST ERROR: 0.0
# NOSIE 290 STRUCT DIST 17.029386365926403 GROUND TRUTH 17.029386365926403

# AT NOISE PERCENT 2.2, STRUCT DIST ERROR: 0.019935555287575325
# NOSIE 304 STRUCT DIST 17.08800749063506 GROUND TRUTH 17.435595774162696

# AT NOISE PERCENT 2.3, STRUCT DIST ERROR: 0.035211105960017176
# NOSIE 318 STRUCT DIST 17.204650534085253 GROUND TRUTH 17.832554500127006

# AT NOISE PERCENT 2.4, STRUCT DIST ERROR: 0.027486178745967482
# NOSIE 332 STRUCT DIST 17.72004514666935 GROUND TRUTH 18.2208671582886

# AT NOISE PERCENT 2.5, STRUCT DIST ERROR: 0.045984838937959106
# NOSIE 345 STRUCT DIST 17.72004514666935 GROUND TRUTH 18.57417562100671

# AT NOISE PERCENT 2.6, STRUCT DIST ERROR: 0.051463522858521446
# NOSIE 359 STRUCT DIST 17.97220075561143 GROUND TRUTH 18.947295321496416

# AT NOISE PERCENT 2.7, STRUCT DIST ERROR: 0.04666522932046849
# NOSIE 373 STRUCT DIST 18.411952639521967 GROUND TRUTH 19.313207915827967

# AT NOISE PERCENT 2.8, STRUCT DIST ERROR: 0.061311046776200306
# NOSIE 387 STRUCT DIST 18.466185312619388 GROUND TRUTH 19.672315572906

# AT NOISE PERCENT 2.9, STRUCT DIST ERROR: 0.059103202767490544
# NOSIE 401 STRUCT DIST 18.841443681416774 GROUND TRUTH 20.024984394500787

# AT NOISE PERCENT 3.0, STRUCT DIST ERROR: 0.043203816271162314
# NOSIE 414 STRUCT DIST 19.467922333931785 GROUND TRUTH 20.346989949375804

# BASE GRAPH /home/ubuntu/project/datasets/beethoven/kunstderfuge/biamonti_360_(c)orlandi/biamonti_360_(c)orlandi_augmented_graph_flat.pickle
# AT NOISE PERCENT 0.1, STRUCT DIST ERROR: 0.0
# NOSIE 16 STRUCT DIST 4.0 GROUND TRUTH 4.0

# AT NOISE PERCENT 0.2, STRUCT DIST ERROR: 0.0
# NOSIE 32 STRUCT DIST 5.656854249492381 GROUND TRUTH 5.656854249492381

# AT NOISE PERCENT 0.3, STRUCT DIST ERROR: 0.0
# NOSIE 49 STRUCT DIST 7.0 GROUND TRUTH 7.0

# AT NOISE PERCENT 0.4, STRUCT DIST ERROR: 0.0
# NOSIE 64 STRUCT DIST 8.0 GROUND TRUTH 8.0

# AT NOISE PERCENT 0.5, STRUCT DIST ERROR: 0.0
# NOSIE 80 STRUCT DIST 8.94427190999916 GROUND TRUTH 8.94427190999916

# AT NOISE PERCENT 0.6, STRUCT DIST ERROR: 0.005167993252386094
# NOSIE 97 STRUCT DIST 9.797958971132712 GROUND TRUTH 9.848857801796104

# AT NOISE PERCENT 0.7, STRUCT DIST ERROR: 0.004434611651310924
# NOSIE 113 STRUCT DIST 10.583005244258363 GROUND TRUTH 10.63014581273465

# AT NOISE PERCENT 0.8, STRUCT DIST ERROR: 0.0
# NOSIE 128 STRUCT DIST 11.313708498984761 GROUND TRUTH 11.313708498984761

# AT NOISE PERCENT 0.9, STRUCT DIST ERROR: 0.0
# NOSIE 144 STRUCT DIST 12.0 GROUND TRUTH 12.0

# AT NOISE PERCENT 1.0, STRUCT DIST ERROR: 0.0
# NOSIE 160 STRUCT DIST 12.649110640673518 GROUND TRUTH 12.649110640673518

# AT NOISE PERCENT 1.1, STRUCT DIST ERROR: 0.0
# NOSIE 176 STRUCT DIST 13.2664991614216 GROUND TRUTH 13.2664991614216

# AT NOISE PERCENT 1.2, STRUCT DIST ERROR: 0.002594038091940772
# NOSIE 193 STRUCT DIST 13.856406460551018 GROUND TRUTH 13.892443989449804

# AT NOISE PERCENT 1.3, STRUCT DIST ERROR: 0.0
# NOSIE 208 STRUCT DIST 14.422205101855956 GROUND TRUTH 14.422205101855956

# AT NOISE PERCENT 1.4, STRUCT DIST ERROR: 0.0
# NOSIE 225 STRUCT DIST 15.0 GROUND TRUTH 15.0

# AT NOISE PERCENT 1.5, STRUCT DIST ERROR: 0.002081167703827602
# NOSIE 240 STRUCT DIST 15.524174696260024 GROUND TRUTH 15.491933384829668

# AT NOISE PERCENT 1.6, STRUCT DIST ERROR: 0.001951221367587408
# NOSIE 256 STRUCT DIST 16.0312195418814 GROUND TRUTH 16.0

# AT NOISE PERCENT 1.7, STRUCT DIST ERROR: 0.0018365488382998093
# NOSIE 272 STRUCT DIST 16.522711641858304 GROUND TRUTH 16.492422502470642

# AT NOISE PERCENT 1.8, STRUCT DIST ERROR: 0.001734606680942415
# NOSIE 288 STRUCT DIST 17.0 GROUND TRUTH 16.97056274847714

# AT NOISE PERCENT 1.9, STRUCT DIST ERROR: 0.0016433864825395694
# NOSIE 304 STRUCT DIST 17.46424919657298 GROUND TRUTH 17.435595774162696

# AT NOISE PERCENT 2.0, STRUCT DIST ERROR: 0.023718790511668343
# NOSIE 320 STRUCT DIST 17.46424919657298 GROUND TRUTH 17.88854381999832

# AT NOISE PERCENT 2.1, STRUCT DIST ERROR: 0.0014892041025247524
# NOSIE 336 STRUCT DIST 18.303005217723125 GROUND TRUTH 18.33030277982336

# AT NOISE PERCENT 2.2, STRUCT DIST ERROR: 0.02736300333951558
# NOSIE 352 STRUCT DIST 18.24828759089466 GROUND TRUTH 18.76166303929372

# AT NOISE PERCENT 2.3, STRUCT DIST ERROR: 0.0
# NOSIE 369 STRUCT DIST 19.209372712298546 GROUND TRUTH 19.209372712298546

# AT NOISE PERCENT 2.4, STRUCT DIST ERROR: 0.031670336268511415
# NOSIE 385 STRUCT DIST 19.0 GROUND TRUTH 19.621416870348583

# AT NOISE PERCENT 2.5, STRUCT DIST ERROR: 0.0012492197250393744
# NOSIE 400 STRUCT DIST 20.024984394500787 GROUND TRUTH 20.0

# AT NOISE PERCENT 2.6, STRUCT DIST ERROR: 0.03299630101733631
# NOSIE 416 STRUCT DIST 19.72308292331602 GROUND TRUTH 20.396078054371138

# AT NOISE PERCENT 2.7, STRUCT DIST ERROR: 0.0389531171107671
# NOSIE 432 STRUCT DIST 19.974984355438178 GROUND TRUTH 20.784609690826528

# AT NOISE PERCENT 2.8, STRUCT DIST ERROR: 0.04791870235394588
# NOSIE 449 STRUCT DIST 20.174241001832016 GROUND TRUTH 21.18962010041709

# AT NOISE PERCENT 2.9, STRUCT DIST ERROR: 0.050750154692030314
# NOSIE 465 STRUCT DIST 20.46948949045872 GROUND TRUTH 21.563858652847824

# AT NOISE PERCENT 3.0, STRUCT DIST ERROR: 0.030678931760310196
# NOSIE 480 STRUCT DIST 21.236760581595302 GROUND TRUTH 21.908902300206645